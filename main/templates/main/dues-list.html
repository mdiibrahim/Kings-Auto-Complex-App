{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dues</title>

    <!-- Include Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" />
    <style>
      :root {
        --primary-color: #eab11a;
        --secondary-color: #f9d448;
        --third-color: #f2f2f2;
        --background-color: #000000;
      }

      body {
        background: url('{% static "car_image.jpg" %}') no-repeat center center fixed;
        background-size: cover;
        color: #333;
      }

      /* Container Styling */
      .container {
        background-color: rgba(255, 255, 255, 0.8) !important;
        padding: 30px;
        border-radius: 10px;
        margin-top: 100px;
        margin-bottom: 100px;
        max-width: 75% !important;
        margin-left: auto;
        margin-right: auto;
      }

      .form-control {
        max-width: 100%;
        margin-bottom: 20px;
      }

      /* Flex container for side-by-side form fields */
      .row {
        display: flex;
        justify-content: space-between;
      }

      /* Button Styling */
      .btn-login {
        background-color: var(--primary-color) !important;
        color: #000;
        font-weight: 700;
        border-radius: 50px;
        padding: 10px 20px;
        text-decoration: none;
        transition: background-color 0.3s, transform 0.3s ease;
      }

      .btn-login:hover {
        background-color: var(--secondary-color) !important;
        transform: scale(1.05);
      }

      /* Styling for search form and button */
      .search-form {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .form-control {
        max-width: 250px;
      }

      /* Table Styling */
      table {
        margin-top: 30px;
      }

      .table th {
        background-color: var(--primary-color);
      }

      tr td {
        color: #333 !important;
        font-weight: 500;
      }

      /* Styling for receive input */
      .receive-input {
        border: 1px solid #ccc; /* Adding border */
        padding: 5px;
        border-radius: 5px;
        width: 100%; /* Ensure input takes available space */
        max-width: 150px; /* Limit max width */
      }

    </style>
  </head>

  <body>
    {% include 'main/navbar.html' %}

    <div class="container text-center">
      <h3 class="mb-3">Due Sales</h3>

      <!-- Search form -->
      <form class="search-form" method="get" action="{% url 'dues_list' %}">
        <input
          class="form-control mt-3"
          type="search"
          placeholder="Search by car name or mobile number"
          aria-label="Search"
          name="q"
          value="{{ query }}"
        />
        <button class="btn btn-login mb-1" type="submit">Search</button>
      </form>

      <br />

      <!-- New table for Due data -->
      <table class="table table-bordered" id="dueTable">
        <thead style="background-color: var(--primary-color);">
          <tr>
            <th>Memo ID</th>
            <th>Due ID</th>
            <th>Mobile Number</th>
            <th>Car</th>
            <th>Due Total</th>
            <th>Due Received</th>
            <th>Receive</th>
          </tr>
        </thead>
        <tbody>
          {% regroup dues by memo_id as memo_dues %}
          {% for memo in memo_dues %}
          {% for due in memo.list %}
          <tr>
            {% if forloop.first %}
            <td rowspan="{{ memo.list|length }}">{{ memo.grouper.memo_id }}</td>
            {% endif %}
            <td>{{ due.due_id }}</td>
            <td>{{ memo.grouper.customer_name }}</td>
            <td>{{ memo.grouper.car_name }}</td>
            <td>{{ due.due_total }}</td>
            <td>{{ due.due_received }}</td>
            <td>
              <form action="{% url 'update_due' due.due_id %}" method="POST">
                {% csrf_token %}
                <input
                  type="number"
                  name="receive-{{ due.due_id }}"
                  id="receive-{{ due.due_id }}"
                  min="0"
                  step="0.01"
                  class="receive-input"
                />
                {% if due.due_received >= due.due_total %}
                <button type="submit" onclick="receiveDue('{{ due.due_id }}')" disabled class="btn btn-login">
                  Receive
                </button>
                {% else %}
                <button class="btn btn-login" type="submit" onclick="receiveDue('{{ due.due_id }}')">
                  Receive
                </button>
                {% endif %}
              </form>
            </td>
          </tr>
          {% endfor %}
          {% empty %}
          <tr>
            <td colspan="7">No due data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% include 'main/footer.html' %}

    <!-- Bootstrap 5 JS (No jQuery required) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function receiveDue(dueId) {
        const inputField = document.getElementById(`pay-${dueId}`);
        const amount = parseFloat(inputField.value);
        if (isNaN(amount) || amount <= 0) {
          alert("Please enter a valid payment amount.");
          return;
        }
      }
    </script>
  </body>
</html>
