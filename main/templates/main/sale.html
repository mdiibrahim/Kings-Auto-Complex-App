{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Create Sale</title>
    <!-- Link to the Favicon -->
    <link rel="icon" href="{% static '/favicon.ico' %}" type="image/x-icon">

    <!-- Include Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"/>

    <style>
        :root {
          --primary-color: #eab11a;
          --secondary-color: #f9d448;
          --third-color: #f2f2f2;
          --background-color: #000000;
        }

        /* Body styling with car background image */
        body {
          background: url('{% static "car_image.jpg" %}') no-repeat center center fixed;
          background-size: cover; /* Ensure the image covers the entire background */
        }

        /* Container for the main content */
        .container {
          background-color: rgba(255, 255, 255, 0.8); /* Make background a little transparent */
          padding: 60px;
          border-radius: 10px;
          margin-top: 100px; /* Add some top margin */
          margin-bottom: 100px; /* Add some bottom margin */
          max-width: 90% !important;

          margin-left: auto; /* Center horizontally */
          margin-right: auto; /* Center horizontally */
        }


        .btn-login {
          background-color: var(--primary-color) !important; /* Primary color as default */
          color: #000;
          font-weight: 700;
          border-radius: 50px;
          padding: 15px;
          transition: background-color 0.3s, transform 0.3s ease;
        }

        .btn-login:hover {
          background-color: var(--secondary-color) !important; /* Secondary color on hover */
          transform: scale(1.05);
        }

.sale{
        position: sticky;
        top: 0;
  background-color: rgba(255, 255, 255, 0.8);
        z-index: 1;
        padding: 5px;

      }

    </style>
</head>

<body>
{% include 'main/navbar.html' %}
<br/>
<div class=" container" >
    <div class="mb-3">
        <h2 class="text-center ">Sales</h2>
    </div>

    <form id="dynamic-form" action="{% url 'create_sale' %}" method="POST">
        {% csrf_token %}


        <div class="d-flex sale rounded justify-content-between align-items-center my-4 flex-wrap ">
            <div class="d-flex align-items-center gap-2">
                <!-- Sale Date -->
                <label for="sale_date" class="col-form-label mb-0">Sale Date:</label>
                <input
                        type="date"
                        id="sale_date"
                        name="sale_date"
                        class="form-control"
                        style="width: 200px;"
                        value=""
                />
            </div>
            <div class="my-1">
                <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
                    <!-- Add Row Button -->
                    <button
                            type="button"
                            id="add-btn"
                            name="add-btn"
                            class="btn btn-outline-success"
                            onclick="addRow()"
                    >
                        Add Row
                    </button>

                    <!-- Grand Total Label and Input -->
                    <label for="grand-total" class="col-form-label mb-0">Grand Total:</label>
                    <input
                            type="text"
                            id="grand-total"
                            class="form-control text-center"
                            style="width: 150px;"
                            readonly
                    />

                    <!-- Confirm Button -->
                    <button
                            id="confirm-button"
                            name="confirm-button"
                            type="button"
                            class="btn btn-login"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmModal"
                    >
                        Confirm
                    </button>
                </div>
            </div>
            <!-- Memo ID with right alignment -->
            <div class="d-flex justify-content-end align-items-center gap-2">
                <label for="memo_id" class="col-form-label mb-0">Memo ID:</label>
                {% if current_memo_id %}
                <input
                        type="text"
                        id="memo_id"
                        name="memo_id"
                        class="form-control"
                        style="width: 150px;"
                        value="{{ current_memo_id }}"
                />
                {% else %}
                <input
                        type="text"
                        id="memo_id"
                        name="memo_id"
                        class="form-control"
                        style="width: 150px;"
                        value="1"
                /> {% endif %}
            </div>
        </div>


       <div class="p-2" style="border: 1px solid black;">
    <div style="font-size: 0.75rem" id="dynamic-rows">
        <!-- Header Row with Labels -->
        <div class="form-row label-row d-flex align-items-center">
            <div class="col-1">
                <label for="sl1">SL No.</label>
            </div>
            <div class="col-1">
                <label for="stuff1">Stuff</label>
            </div>
            <div class="col-1">
                <label for="customer-name1">Mobile</label>
            </div>
            <div class="col-1">
                <label for="car-name1">Car Name</label>
            </div>
            <div class="col-1">
                <label for="car-name1">Color</label>
            </div>
            <div class="col-1">
                <label for="car-registration1">Reg</label>
            </div>
            <div class="col-1">
                <label for="service1">Service</label>
            </div>
            <div class="col-1">
                <label for="total1">Total</label>
            </div>
            <div class="col-1">
                <label for="discount-percentage1">Discount (%)</label>
            </div>
            <div class="col-1">
                <label for="paid-total1">Cash</label>
            </div>
            <div class="col-1">
                <label for="due-amount1">Due</label>
            </div>
            <div class="col-1">
                <label for="payment-status1">Status</label>
            </div>
            <div class="col-1">
                <label>&nbsp;</label>
            </div>
        </div>

        <!-- Dynamic Row with Input Fields -->
        {% for i in "1" %}
        <div class="form-row d-flex align-items-center">
            <div class="col-.5 text-center">
                <input style="font-size: small; height: 40px" type="text" id="sl{{ forloop.counter }}" name="sl{{ forloop.counter }}" class="form-control text-center " value="{{ forloop.counter }}" required />
            </div>
            <div class="col-1">
                <select style="font-size: small; height: 40px" id="stuff{{ forloop.counter }}" name="stuff{{ forloop.counter }}" class="form-select" required>
                    {% for stuff in stuffs %}
                    <option value="{{ stuff.stuff_id }}">{{ stuff.stuff_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-1">
                <input style="font-size: smaller; height: 40px" type="text" id="customer-name{{ forloop.counter }}" name="customer-name{{ forloop.counter }}" class="form-control" value="01" maxlength="11" oninput="enforceMobilePrefix(this)" required />
            </div>
            <div class="col-1">
                <input style="font-size: smaller; height: 40px" type="text" id="car-name{{ forloop.counter }}" name="car-name{{ forloop.counter }}" class="form-control" required />
            </div>
            <div class="col-1">
                <select style="font-size: small; height: 40px" id="color{{ forloop.counter }}" name="color{{ forloop.counter }}" class="form-select" onchange="checkCustomColor(this)" required>
                    <option value="" selected>Choose Color</option>
                    <option value="black">Black</option>
                    <option value="white">White</option>
                    <option value="red wine">Red Wine</option>
                    <option value="mica blue">Mica Blue</option>
                    <option value="blue">Blue</option>
                    <option value="sky blue">Sky Blue</option>
                    <option value="gray">Gray</option>
                    <option value="golden">Golden</option>
                    <option value="silver">Silver</option>
                    <option value="bronze">Bronze</option>
                    <option value="pearl white">Pearl White</option>
                    <option value="cheery">Cheery</option>
                    <option value="red">Red</option>
                    <option value="green">Green</option>
                    <option value="yellow">Yellow</option>
                    <option value="orange">Orange</option>
                    <option value="pink">Pink</option>
                </select>
            </div>
            <div class="col-1">
                <input style="font-size: smaller; height: 40px" type="text" id="car-registration{{ forloop.counter }}" name="car-registration{{ forloop.counter }}" class="form-control" />
            </div>
            <div class="col-1">
                <select style="font-size: small; height: 40px" name="service{{ forloop.counter }}" class="form-select" onclick="calculateTotal(this)" required>
                    {% for service in services %}
                    <option value="{{ service.service_id }}" data-charge="{{ service.service_charge }}">{{ service.service_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-1">
                <input style="font-size: small; height: 40px" value="0" type="text" id="total{{ forloop.counter }}" name="total{{ forloop.counter }}" class="form-control" required />
            </div>
            <div class="col-1">
                <input style="font-size: small; height: 40px" type="text" id="discount-percentage{{ forloop.counter }}" name="discount-percentage{{ forloop.counter }}" min="0" max="100" value="0" oninput="updateDynGrandTotal(this, '{{ forloop.counter }}')" class="form-control" />
            </div>
            <div class="col-1">
                <input style="font-size: small; height: 40px" type="text" id="paid-total{{ forloop.counter }}" name="paid-total{{ forloop.counter }}" min="0" class="form-control" oninput="updateDueAmount(this, '{{ forloop.counter }}')" required />
            </div>
            <div class="col-1">
                <input style="font-size: small; height: 40px" value="0" type="text" id="due-amount{{ forloop.counter }}" name="due-amount{{ forloop.counter }}" min="0" class="form-control" required />
            </div>
            <div class="col-1">
                <select style="font-size: small; height: 40px" id="payment-status{{ forloop.counter }}" name="payment-status{{ forloop.counter }}" class="form-select" onclick="handlePaymentStatusChange(this)" required>
                    <option value="unpaid" selected>Unpaid</option>
                    <option value="cash">Cash Paid</option>
                    <option value="bkash">Bkash Paid</option>
                    <option value="nagad">Nagad Paid</option>
                    <option value="card">Card Paid</option>
                </select>
            </div>
            <div class="">
                <span class="btn btn-danger" onclick="removeRow(this)">X</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>



    </form>
</div>
<!-- Confirm Submission Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to submit the sale details? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-login" id="confirmSubmitBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

{% include 'main/footer.html' %}
<!-- Bootstrap 5 JS (No jQuery required) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Function to validate required fields before submission
function validateRequiredFields() {
  let isValid = true;

  // Select all required input fields
  const requiredFields = document.querySelectorAll('input[required], select[required]');

  // Loop through each required field and check if it's empty
  requiredFields.forEach(function(field) {
      if (!field.value) {
          field.style.borderColor = "red";  // Highlight empty field with red border
          isValid = false;
      } else {
          field.style.borderColor = "";  // Reset border color
      }
  });

  // If any required field is empty, return false to prevent submission
  return isValid;
}

// Attach the validation function to the "Confirm" button click event
document.getElementById("confirmSubmitBtn").addEventListener("click", function () {
  if (validateRequiredFields()) {
      // If all required fields are filled, submit the form
      isFormDirty = false;
      document.getElementById("dynamic-form").submit();
  } else {
      // If there are empty required fields, display an alert
      alert("Please fill in all required fields before confirming.");
  }
});


    // Ensure the input always starts with 01 and prevent deleting the prefix
    function enforceMobilePrefix(input) {
      const prefix = "01";
      if (!input.value.startsWith(prefix)) {
        input.value = prefix;
      }
      // Prevent the user from deleting the prefix
      if (input.selectionStart < prefix.length) {
        input.setSelectionRange(prefix.length, prefix.length);
      }
    }

    // Initial enforce for existing inputs
    document
      .querySelectorAll('input[id^="customer-name"]')
      .forEach((input) => {
        enforceMobilePrefix(input);
      });

    // Get the current date in the format "YYYY-MM-DD"
    var currentDate = new Date().toISOString().slice(0, 10);

    // Set the default value of the input field to the current date
    document.getElementById("sale_date").value = currentDate;

    // Flag to indicate if the form has unsaved changes
    let isFormDirty = false;

    // Function to set the form as dirty if any input has a value
    function setFormDirty() {
      isFormDirty = true;
    }
    function validateForm(event) {
      let isValid = true;

      // Validate static fields
      const grandTotalInput = document.getElementById("grand-total");
      if (!grandTotalInput.value) {
        grandTotalInput.style.borderColor = "red"; // Highlight empty field
        isValid = false;
      } else {
        grandTotalInput.style.borderColor = ""; // Reset border color
      }

      // Optionally, validate dynamic rows
      const dynamicRows = document.querySelectorAll(".form-row");
      dynamicRows.forEach((row) => {
        const inputs = row.querySelectorAll("input, select");
        inputs.forEach((input) => {
          // Skip validation for the registration number field
          if (input.id.startsWith("car-registration")) {
            input.style.borderColor = ""; // Reset border color, skip validation
            return; // Skip further validation for this field
          }
          if (!input.value) {
            input.style.borderColor = "red"; // Highlight empty field
            isValid = false;
          } else {
            input.style.borderColor = ""; // Reset border color
          }
        });
      });

      if (!isValid) {
        event.preventDefault(); // Prevent form submission if invalid
      }
    }

    // Add event listener to the form
    document.querySelector("form").addEventListener("submit", validateForm);
    function checkCustomColor(selectElement) {
      if (selectElement.value === "") {
        var customColor = prompt("Enter custom color:");
        if (customColor !== null) {
          // Add the custom color as an option
          var option = document.createElement("option");
          option.text = customColor;
          option.value = customColor;
          selectElement.appendChild(option);
          // Select the custom color
          selectElement.value = customColor;
        } else {
          // Reset to default selection
          selectElement.value = "";
        }
      }
    }
    // Add event listeners to existing inputs and selects
    function addListenersToInputs(inputs) {
      inputs.forEach((input) => {
        input.addEventListener("input", setFormDirty);
        input.addEventListener("change", setFormDirty);
      });
    }

    // Initialize listeners for existing form inputs
    const formInputs = document.querySelectorAll(
      "#dynamic-form input, #dynamic-form select"
    );
    addListenersToInputs(formInputs);

    // Add event listener for the beforeunload event to display a confirmation dialog if form is dirty
    window.addEventListener("beforeunload", (e) => {
      if (isFormDirty) {
        const confirmationMessage =
          "You have unsaved changes. Are you sure you want to leave?";
        e.returnValue = confirmationMessage; // For cross-browser compatibility
        return confirmationMessage;
      }
    });

    // Reset the flag when the form is successfully submitted
    document.getElementById("dynamic-form").addEventListener("submit", () => {
      isFormDirty = false;
    });

    // Function to handle payment status change
    function handlePaymentStatusChange(selectElement) {
      const rowNumber = selectElement.id.split("payment-status")[1];
      const totalElement = document.getElementById("total" + rowNumber);
      const paidTotalElement = document.getElementById(
        "paid-total" + rowNumber
      );
      const dueAmountElement = document.getElementById(
        "due-amount" + rowNumber
      );
      const discountPercentageElement = document.getElementById(
        "discount-percentage" + rowNumber
      );

      const total = parseFloat(totalElement.value) || 0;
      const discountPercentage =
        parseFloat(discountPercentageElement.value) || 0;
      const discountAmount = (total * discountPercentage) / 100;
      const payableAmount = total - discountAmount;

      if (
        selectElement.value === "cash" ||
        selectElement.value === "bkash" ||
        selectElement.value === "nagad" ||
        selectElement.value === "card"
      ) {
        paidTotalElement.value = payableAmount.toFixed(2);
        dueAmountElement.value = "0";
      } else {
        paidTotalElement.value = "0";
        dueAmountElement.value = payableAmount.toFixed(2);
      }

      calculateGrandTotal();
    }
    function calculateTotal(selectElement) {
      var row = selectElement.parentNode.parentNode;
      var serviceSelect = row.querySelector('select[name^="service"]');
      var selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
      var serviceCharge = parseFloat(
        selectedOption.getAttribute("data-charge")
      );

      row.querySelector('input[name^="total"]').value =
        serviceCharge.toFixed(2);

      calculateGrandTotal();
    }

    function calculateGrandTotal() {
      var totalInputs = document.querySelectorAll(
        'input[name^="paid-total"]'
      );
      var grandTotal = 0;

      totalInputs.forEach(function (input) {
        var totalValue = parseFloat(input.value);
        if (!isNaN(totalValue)) {
          grandTotal += totalValue;
        }
      });

      var grandTotalInput = document.getElementById("grand-total");
      if (!grandTotalInput) {
        // Create the grand total input field if it doesn't exist
        grandTotalInput = document.createElement("input");
        grandTotalInput.type = "text";
        grandTotalInput.id = "grand-total";
        grandTotalInput.readOnly = true;

        // Find the "Add Row" button
        var addButton = document.getElementById("add-btn");

        // Get the parent container of the "Add Row" button
        var parentContainer = addButton.parentNode;

        // Create a new div element for the grand total input field and its label
        var grandTotalDiv = document.createElement("div");
        grandTotalDiv.classList.add("col");

        // Create a label for the grand total input field
        var grandTotalLabel = document.createElement("label");
        grandTotalLabel.textContent = "Total: ";

        // Append the label and input field to the div
        grandTotalDiv.appendChild(grandTotalLabel);
        grandTotalDiv.appendChild(grandTotalInput);

        // Insert the div after the "Add Row" button
        parentContainer.insertBefore(grandTotalDiv, addButton.nextSibling);
      }

      grandTotalInput.value = grandTotal.toFixed(2);
    }

    function updateDynGrandTotal(selectElement, dyn_id) {
      var dynTotalInp = "total" + String(dyn_id);

      var dynTotal =
        parseFloat(document.getElementById(dynTotalInp).value) || 0;

      var dynDiscountInp = "discount-percentage" + String(dyn_id);
      var discountPercentage =
        parseInt(document.getElementById(dynDiscountInp).value) || 0;
      var discountAmount = dynTotal * (discountPercentage / 100);
      var grandDynTotal = dynTotal - discountAmount;

      document.getElementById(dynTotalInp).value = grandDynTotal.toFixed(2);

      calculateGrandTotal();
    }

    // Function to add a new row dynamically
    function addRow() {
      // Get the container element for dynamic rows
      var dynamicRowsContainer = document.getElementById("dynamic-rows");

      // Create a new div element for the row
      var newRow = document.createElement("div");
      newRow.className = "form-row";

      // Generate a unique ID for the row
      var uniqueId = Date.now();

      // Get all the rows in the container
      var rows = dynamicRowsContainer.querySelectorAll(".form-row");

      // Check if there are any existing rows
      var lastRow = rows[rows.length - 1];
      var lastSlValue = 0;

      if (lastRow) {
        // Get the SL number input in the last row
        var lastSlInput = lastRow.querySelector("input[name^='sl']");

        // Get the value of the SL number input in the last row
        lastSlValue = parseInt(lastSlInput.value);
      }

      // Construct the row HTML using Bootstrap 4 classes
      newRow.innerHTML = `

       <!-- Dynamic Row with Input Fields -->
<div class="form-row d-flex align-items-center">
    <!-- SL No. Input -->
    <div class="col-.5 text-center">
        <input
            style="font-size: small; height: 40px"
            type="text"
            id="sl${lastSlValue + 1}"
            name="sl${lastSlValue + 1}"
            class="form-control text-center"
            value="${lastSlValue + 1}"
            required
        />
    </div>

    <!-- Stuff Dropdown -->
    <div class="col-1">
        <select
            style="font-size: small; height: 40px"
            id="stuff${lastSlValue + 1}"
            name="stuff${lastSlValue + 1}"
            class="form-select"
            required
        >
            {% for stuff in stuffs %}
            <option value="{{ stuff.stuff_id }}">{{ stuff.stuff_name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Customer Name Input -->
    <div class="col-1">
        <input
            style="font-size: smaller; height: 40px"
            type="text"
            id="customer-name${lastSlValue + 1}"
            name="customer-name${lastSlValue + 1}"
            class="form-control"
            value="01"
            maxlength="11"
            oninput="enforceMobilePrefix(this)"
            required
        />
    </div>

    <!-- Car Name Input -->
    <div class="col-1">
        <input
            style="font-size: smaller; height: 40px"
            type="text"
            id="car-name${lastSlValue + 1}"
            name="car-name${lastSlValue + 1}"
            class="form-control"
            required
        />
    </div>

    <!-- Color Dropdown -->
    <div class="col-1">
        <select
            style="font-size: small; height: 40px"
            id="color${lastSlValue + 1}"
            name="color${lastSlValue + 1}"
            class="form-select"
            onchange="checkCustomColor(this)"
            required
        >
            <option value="" selected>Choose Color</option>
            <option value="black">Black</option>
            <option value="white">White</option>
            <option value="red wine">Red Wine</option>
            <option value="mica blue">Mica Blue</option>
            <option value="blue">Blue</option>
            <option value="sky blue">Sky Blue</option>
            <option value="gray">Gray</option>
            <option value="golden">Golden</option>
            <option value="silver">Silver</option>
            <option value="bronze">Bronze</option>
            <option value="pearl white">Pearl White</option>
            <option value="cheery">Cheery</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="orange">Orange</option>
            <option value="pink">Pink</option>
        </select>
    </div>

    <!-- Car Registration Input -->
    <div class="col-1">
        <input
            style="font-size: smaller; height: 40px"
            type="text"
            id="car-registration${lastSlValue + 1}"
            name="car-registration${lastSlValue + 1}"
            class="form-control"
        />
    </div>

    <!-- Service Dropdown -->
    <div class="col-1">
        <select
            style="font-size: small; height: 40px"
            name="service${lastSlValue + 1}"
            class="form-select"
            onclick="calculateTotal(this)"
            required
        >
            {% for service in services %}
            <option value="{{ service.service_id }}" data-charge="{{ service.service_charge }}">
                {{ service.service_name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Total Input -->
    <div class="col-1">
        <input
            style="font-size: small; height: 40px"
            value="0"
            type="text"
            id="total${lastSlValue + 1}"
            name="total${lastSlValue + 1}"
            class="form-control"
            required
        />
    </div>

    <!-- Discount Percentage Input -->
    <div class="col-1">
        <input
            style="font-size: small; height: 40px"
            type="text"
            id="discount-percentage${lastSlValue + 1}"
            name="discount-percentage${lastSlValue + 1}"
            min="0"
            max="100"
            value="0"
            oninput="updateDynGrandTotal(this, '${lastSlValue + 1}')"
            class="form-control"
        />
    </div>

    <!-- Paid Total Input -->
    <div class="col-1">
        <input
            style="font-size: small; height: 40px"
            type="text"
            id="paid-total${lastSlValue + 1}"
            name="paid-total${lastSlValue + 1}"
            min="0"
            class="form-control"
            oninput="updateDueAmount(this, '${lastSlValue + 1}')"
            required
        />
    </div>

    <!-- Due Amount Input -->
    <div class="col-1">
        <input
            style="font-size: small; height: 40px"
            value="0"
            type="text"
            id="due-amount${lastSlValue + 1}"
            name="due-amount${lastSlValue + 1}"
            min="0"
            class="form-control"
            required
        />
    </div>

    <!-- Payment Status Dropdown -->
    <div class="col-1">
        <select
            style="font-size: small; height: 40px"
            id="payment-status${lastSlValue + 1}"
            name="payment-status${lastSlValue + 1}"
            class="form-select"
            onclick="handlePaymentStatusChange(this)"
            required
        >
            <option value="unpaid" selected>Unpaid</option>
            <option value="cash">Cash Paid</option>
            <option value="bkash">Bkash Paid</option>
            <option value="nagad">Nagad Paid</option>
            <option value="card">Card Paid</option>
        </select>
    </div>

    <!-- Remove Row Button -->
    <div>
        <span class="btn btn-danger" onclick="removeRow(this)">X</span>
    </div>
</div>


`;

      // Append the new row to the dynamic rows container
      dynamicRowsContainer.appendChild(newRow);

      // Create an empty div element for line break
      var lineBreak = document.createElement("div");
      lineBreak.className = "mb-8";

      // Append the line break after the new row
      dynamicRowsContainer.appendChild(lineBreak);

      // Add listeners to the new inputs in the row
      const newInputs = newRow.querySelectorAll("input, select");
      addListenersToInputs(newInputs);
    }
    function updateRowIDsAndListeners() {
      const rows = document.querySelectorAll(
        "#dynamic-rows .form-row:not(.label-row)"
      );
      rows.forEach((row, index) => {
        const rowNumber = index + 1;

        // Update IDs and names for each input in the row
        const inputs = row.querySelectorAll("input, select");
        inputs.forEach((input) => {
          const name = input.name.replace(/\d+$/, rowNumber);
          const id = input.id.replace(/\d+$/, rowNumber);
          input.name = name;
          input.id = id;

          // Update data-row attribute for payment status select
          if (
            input.tagName === "SELECT" &&
            input.name.startsWith("payment-status")
          ) {
            input.dataset.row = rowNumber;
          }

          // Re-apply event listeners for new IDs
          input.removeEventListener("input", setFormDirty);
          input.removeEventListener("change", setFormDirty);
          input.addEventListener("input", setFormDirty);
          input.addEventListener("change", setFormDirty);

          if (input.name.startsWith("service")) {
            input.removeEventListener("change", calculateTotal);
            input.addEventListener("change", calculateTotal);
          } else if (input.name.startsWith("payment-status")) {
            input.removeEventListener("change", handlePaymentStatusChange);
            input.addEventListener("change", handlePaymentStatusChange);
          } else if (input.name.startsWith("discount-percentage")) {
            input.removeEventListener("change", updateDynGrandTotal);
            input.addEventListener("change", updateDynGrandTotal);
          }
        });

        // Update SL value
        const slInput = row.querySelector("input[name^='sl']");
        if (slInput) {
          slInput.value = rowNumber;
        }
      });
    }
    function removeRow(button) {
      const row = button.parentNode.parentNode;
      row.remove();

      // After removing a row, update IDs and listeners
      updateRowIDsAndListeners();

      // Recalculate the grand total after removing the row
      calculateGrandTotal();
    }

    // Function to calculate and update the due amount
    function updateDueAmount(element, rowNumber) {
      // Get the paid-total input element
      var paidTotalInput = document.getElementById("paid-total" + rowNumber);

      // Get the total input element
      var totalInput = document.getElementById("total" + rowNumber);

      // Get the due-amount input element
      var dueAmountInput = document.getElementById("due-amount" + rowNumber);

      // Get the paid total value
      var paidTotal = parseFloat(paidTotalInput.value);

      // Get the total value
      var total = parseFloat(totalInput.value);

      // Calculate the due amount
      var dueAmount = total - paidTotal;

      // Update the due-amount input field with the calculated value
      dueAmountInput.value = dueAmount.toFixed(2);

      calculateGrandTotal();
    }

    // Add onchange event listeners to paid-total input fields
    var paidTotalInputs = document.querySelectorAll(
      "input[id^='paid-total']"
    );
    for (var i = 0; i < paidTotalInputs.length; i++) {
      var paidTotalInput = paidTotalInputs[i];
      var rowNumber = paidTotalInput.id.replace("paid-total", "");
      paidTotalInput.onchange = function () {
        updateDueAmount(this, rowNumber);
      };
    }

    // Add confirmation prompt on form submission
    document
      .getElementById("dynamic-form")
      .addEventListener("submit", function (event) {
        if (!confirm("Are you sure you want to submit the form?")) {
          event.preventDefault();
        }
      });
</script>
</body>
</html>
